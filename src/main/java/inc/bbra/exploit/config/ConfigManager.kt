package inc.bbra.exploit.config

import com.google.gson.GsonBuilder
import inc.bbra.exploit.BBraExploit
import inc.bbra.exploit.Client
import inc.bbra.exploit.chatSettings.MsgList
import inc.bbra.exploit.chatSettings.getListOfConfigs
import inc.bbra.exploit.clickgui.GUI
import inc.bbra.exploit.clickgui.modules.settings.BoolSetting
import inc.bbra.exploit.clickgui.modules.settings.FloatSetting
import inc.bbra.exploit.clickgui.modules.settings.IntSetting
import inc.bbra.exploit.clickgui.modules.settings.ModeSetting
import kotlinx.coroutines.GlobalScope
import kotlinx.coroutines.launch
import org.json.simple.JSONObject
import org.json.simple.parser.JSONParser
import org.lwjgl.input.Keyboard
import java.io.File
import java.io.FileReader

object ConfigManager {

    var writer = GsonBuilder().setPrettyPrinting().create()
    var postfix = "json"
    var configName = "default"

    var dir = File("BBraExploit/config")
    var file = File(dir, "$configName.$postfix")
    var bindFile = File(dir, "binds.$postfix")
    var cfgUsingRn = File("BBraExploit", "usedConfig.txt")

    var moduleList = hashMapOf<String, HashMap<String, String>>()
    var bindsList = hashMapOf<String, String>()

    var reader: JSONObject? = null
    var readerBinds: JSONObject? = null

    fun startup() {
        try {
            dir.setWritable(true)
            file.setWritable(true)
            bindFile.setWritable(true)
            BBraExploit.logger.info("ConfigManager init")
            getUsedBeforeConfig()
            parse()
            refreshModules()
            readBinds()
            dir.setReadOnly()
            file.setReadOnly()
            bindFile.setReadOnly()
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    fun getUsedBeforeConfig() {
        try {
            if (!getListOfConfigs().contains(cfgUsingRn.readText())) {
                configName = "default"
            } else {
                configName = cfgUsingRn.readText()
            }
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    fun setUsedBeforeConfig() {
        try {
            cfgUsingRn.writeText(configName)
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    fun setOtherCfg(name: String) {
        try {
            dir.setWritable(true)
            file.setWritable(true)
            bindFile.setWritable(true)
            configName = name
            file = File(dir, "$configName.$postfix")
            setUsedBeforeConfig()
            updMap("cfg", hashMapOf("using" to configName))
            parse()
            refreshModules()
            refreshCategories()
            dir.setReadOnly()
            file.setReadOnly()
            bindFile.setReadOnly()
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    fun writeBinds() {
        for (i in Client.modules) {
            bindsList.put(i.name, Keyboard.getKeyName(i.keyCode))
        }
        bindFile.writeText(writer.toJson(bindsList))
    }

    fun readBinds() {
        if (!readerBinds.isNullOrEmpty()) {
            BBraExploit.logger.info("Binds loaded successfully")
            for (i in Client.modules) {
                if (readerBinds!!.getValue(i.name) == "NONE") {
                    i.keyCode = Keyboard.KEY_NONE
                } else i.keyCode = Keyboard.getKeyIndex(readerBinds!!.getValue(i.name) as String?)
            }
        }
    }

    fun saveCfg() = GlobalScope.launch {
        try {
            dir.setWritable(true)
            file.setWritable(true)
            bindFile.setWritable(true)
            makeFile()
            JSONStuff()
            writeBinds()
            file.writeText(writer.toJson(moduleList))
            dir.setReadOnly()
            file.setReadOnly()
            bindFile.setReadOnly()
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }


    fun makeFile() {
        if (!dir.exists()) {
            dir.mkdirs()
        }
        if (!cfgUsingRn.exists()) {
            cfgUsingRn.createNewFile()
        }
        if (!file.exists()) {
            file.createNewFile()
        }
        if (!bindFile.exists()) {
            bindFile.createNewFile()
        }
    }

    fun JSONStuff() {
        for (i in Client.modules) {
            updMap(
                i.name, hashMapOf(
                    "enabled" to i.isEnabled.toString()
                )
            )
            if (i.havePages) {
                updMap(
                    i.name, hashMapOf(
                        "page" to i.pageSeenRN.toString()
                    )
                )
            }
            if (i.haveSettings) {
                for (j in i.settings) {
                    when (j) {
                        is IntSetting -> {
                            updMap(i.name, hashMapOf(j.name to j.`val`.toString().replace(".0", "")))
                        }
                        is FloatSetting -> {
                            updMap(i.name, hashMapOf(j.name to j.`val`.toString()))
                        }
                        is BoolSetting -> {
                            updMap(i.name, hashMapOf(j.name to j.`val`.toString()))
                        }
                        is ModeSetting -> {
                            updMap(i.name, hashMapOf(j.name to j.`val`))
                        }
                    }
                }
            }
        }

        for (i in GUI.categoryList) {
            updMap("CLICK GUI", hashMapOf(i.category.name + " x" to i.x.toString().replace(".0", "")))
            updMap("CLICK GUI", hashMapOf(i.category.name + " y" to i.y.toString().replace(".0", "")))
            updMap("CLICK GUI", hashMapOf(i.category.name + " is deployed" to i.deployed.toString().replace(".0", "")))
        }
    }

    fun updMap(name: String, value: HashMap<String, String>) {
        if (moduleList.containsKey(name)) {
            val valuePrev = moduleList.getValue(name)
            moduleList[name] = (valuePrev + value) as HashMap<String, String>
        } else {
            moduleList[name] = value
        }
    }

    fun parse() {
        reader = JSONParser().parse(FileReader("BBraExploit/config/$configName.$postfix")) as JSONObject
        readerBinds = JSONParser().parse(FileReader("BBraExploit/config/binds.$postfix")) as JSONObject
    }

    fun refreshModules() {
        if (!reader.isNullOrEmpty()) {
            for (module in Client.modules) {
                val moduleSets = reader!![module.name] as HashMap<String, String>
                module.toggled = moduleSets.getValue("enabled") == "true";

                if (module.havePages) {
                    module.pageSeenRN = moduleSets.getValue("page").toInt()
                }

                for (s in module.settings) {
                    when (s) {
                        is IntSetting -> {
                            s.value = moduleSets.getValue(s.name).toInt()
                        }
                        is FloatSetting -> {
                            s.value = moduleSets.getValue(s.name).toFloat()
                        }
                        is BoolSetting -> {
                            s.value = moduleSets.getValue(s.name).toBoolean()
                        }
                        is ModeSetting -> {
                            s.modeSeenRN = s.modes.indexOf(moduleSets.getValue(s.name))
                        }
                    }
                }
            }
        }
    }

    fun refreshCategories() {
        if (!reader.isNullOrEmpty()) {
            val guiSets = reader!!["CLICK GUI"] as HashMap<String, String>
            for (c in GUI.categoryList) {
                c.x = guiSets.getValue("${c.category.name} x").toInt()
                c.y = guiSets.getValue("${c.category.name} y").toInt()
                if (guiSets.getValue("${c.category.name} is deployed") == "true") {
                    c.deploy()
                } else c.undeploy()
            }
        }
    }
}

