package inc.bbra.exploit.mixin.impl;

import inc.bbra.exploit.event.events.BlockEvent;
import net.minecraft.block.material.Material;
import net.minecraft.client.Minecraft;
import net.minecraft.client.multiplayer.WorldClient;
import net.minecraft.client.renderer.DestroyBlockProgress;
import net.minecraftforge.common.MinecraftForge;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.Inject;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;

@Mixin(DestroyBlockProgress.class)
public class MixinDestroyBlockProgress {
    @Inject(method = "setPartialBlockDamage", at = @At("HEAD"))
    public void onBlockDmg(int damage, CallbackInfo ci) {
        DestroyBlockProgress INSTANCE = (DestroyBlockProgress) (Object) this;
        WorldClient world = Minecraft.getMinecraft().world;
        if (world != null) {
            int dmg = damage;
            if (Minecraft.getMinecraft().world.getBlockState(INSTANCE.getPosition()).getMaterial() != Material.AIR) {
                if (damage > 10) {
                    dmg = 10;
                }
                BlockEvent.BreakInProgress event = new BlockEvent.BreakInProgress(world, INSTANCE.getPosition(), dmg, Minecraft.getMinecraft().world.getBlockState(INSTANCE.getPosition()));
                MinecraftForge.EVENT_BUS.post(event);
            }
        }
    }
}
